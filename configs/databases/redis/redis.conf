# Redis Configuration for BMAD Studio Template
# High Performance & High Availability Configuration
# Redis 7.0+

################################## NETWORK #####################################

# Bind to all interfaces in production with proper security
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

################################# TLS/SSL ######################################

# TLS/SSL configuration for secure connections
port 0
tls-port 6380
tls-cert-file /etc/redis/tls/redis.crt
tls-key-file /etc/redis/tls/redis.key
tls-ca-cert-file /etc/redis/tls/ca.crt
tls-dh-params-file /etc/redis/tls/redis.dh
tls-protocols "TLSv1.2 TLSv1.3"
tls-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
tls-prefer-server-ciphers yes
tls-session-caching no
tls-session-cache-size 5000
tls-session-cache-timeout 60

################################# GENERAL #####################################

daemonize no
pidfile /var/run/redis/redis-server.pid
loglevel notice
logfile /var/log/redis/redis-server.log
databases 16
always-show-logo no
set-proc-title yes
proc-title-template "{title} {listen-addr} {server-mode}"

################################ SECURITY ######################################

# Authentication
requirepass ${REDIS_PASSWORD}
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_9f2d8a3b4c5e6f7a8b9c0d1e2f3a4b5c"

# Access Control List (ACL)
aclfile /etc/redis/users.acl

################################### CLIENTS ####################################

maxclients 10000

############################## MEMORY MANAGEMENT #################################

maxmemory 2gb
maxmemory-policy allkeys-lru
maxmemory-samples 5
replica-ignore-maxmemory yes
active-expire-effort 1

############################# LAZY FREEING ####################################

lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes

############################ KERNEL OOM CONTROL ##############################

oom-score-adj no

############################ KERNEL TRANSPARENT HUGEPAGE CONTROL ##############

disable-thp yes

############################## APPEND ONLY MODE ###############################

appendonly yes
appendfilename "appendonly.aof"
appenddirname "appendonlydir"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes
aof-timestamp-enabled no

################################ LUA SCRIPTING  ###############################

lua-time-limit 5000

################################ REDIS CLUSTER  ###############################

# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-announce-hostname ""
# cluster-announce-port 0
# cluster-announce-tls-port 0
# cluster-announce-bus-port 0
# cluster-migration-barrier 1
# cluster-require-full-coverage yes

########################## CLUSTER DOCKER/NAT support  ########################

# cluster-announce-ip 10.1.1.5

################################## SLOW LOG ###################################

slowlog-log-slower-than 10000
slowlog-max-len 128

################################ LATENCY MONITOR ##############################

latency-monitor-threshold 100

############################# EVENT NOTIFICATION ##############################

notify-keyspace-events "Ex"

############################### ADVANCED CONFIG ###############################

hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
hz 10
dynamic-hz yes
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes
jemalloc-bg-thread yes

# Redis modules
# loadmodule /usr/lib/redis/modules/redisearch.so
# loadmodule /usr/lib/redis/modules/redisjson.so